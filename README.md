<div align="center">
      <h1>OpenDPO</h1>
</div>
<div align="center">
    <p align="center">
          <em> Open-source / Lightweight / Easy-to-use / Large-Scale / Extra-Long-Text </em>
    </p>
</div>

<hr>

DPOçš„æŸå¤±å‡½æ•°å¯ä»¥åšå¦‚ä¸‹æ’ç­‰å˜æ¢ï¼Œå¯ä»¥å‘ç°æ¡†ä¸­çš„ç»“æœæ˜¯ä¸€ä¸ªå¯ä»¥é¢„è®¡ç®—çš„å¸¸æ•°ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨DPOè¿›è¡Œä¼˜åŒ–æ—¶ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç¦»çº¿è®¡ç®—å¸¸æ•°éƒ¨åˆ†ï¼Œåœ¨çº¿åªéœ€è¦åŠ è½½$p_\theta$è¿›è¡Œè®­ç»ƒï¼Œè¿™æ ·å’Œsftçš„è®­ç»ƒç›¸å·®æ— å‡ ã€‚

$$
\begin{align*}
\mathcal{L}_{DPO}(p_{\theta}; p_{ref}) &= -\mathbb{E}_{(x,y_w,y_l)\sim D} \left[\log \sigma \left(\beta \log \frac{p_{\theta}(y_w|x)}{p_{ref}(y_w|x)} - \beta \log \frac{p_{\theta}(y_l|x)}{p_{ref}(y_l|x)}\right)\right]\\
&= -\mathbb{E}_{(x,y_w,y_l)\sim D} \left[\log \sigma \left(\beta \log \frac{p_{\theta}(y_w|x)}{p_{\theta}(y_l|x)} - \boxed{\beta \log \frac{p_{ref}(y_w|x)}{p_{ref}(y_l|x)}}\right)\right]
\end{align*}
$$

æ ¹æ®æ­¤æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨[OpenSFT](https://github.com/mlpod/OpenSFT/tree/main)ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚ æ¶‰åŠåˆ°çš„ç‚¹ä¸»è¦æ˜¯ref_modelçš„ç¦»çº¿log_probçš„æ¨ç†å’Œåœ¨çº¿æŸå¤±çš„è®¡ç®—ã€‚

ref_modelçš„ç¦»çº¿log_probçš„æ¨ç†éƒ¨åˆ†å¯ä»¥å‚è€ƒdata/raw/infer.pyï¼Œé‡Œé¢åŒ…å«ä¸¤ç§æ–¹å¼ï¼š
1. ç»™å®š<x>ï¼Œè¾“å‡ºyå’Œyçš„æ¦‚ç‡ï¼›
2. ç»™å®š<x,y>ï¼Œè¾“å‡ºyçš„æ¦‚ç‡ï¼›

åŒæ¨¡å‹åŒyä¸‹ï¼Œä¸¤ç§æ–¹æ³•å­˜åœ¨ç²¾åº¦å·®å¼‚ï¼Œå½±å“ä¸å¤§ã€‚

### ç¯å¢ƒå®‰è£…

```bash
git clone https://github.com/mlpod/OpenDPO.git
cd OpenDPO/train
pip install -r requirements.txt
```

### æ•°æ®ç»„ç»‡æ–¹å¼

è¯¦è§https://github.com/mlpod/OpenSFT/tree/main

æ•°æ®å¤„ç†ä»£ç æ”¾åœ¨äº†dataç›®å½•ä¸­ã€‚dataç›®å½•ä¸­çš„rawç›®å½•æ˜¯å­˜æ”¾æœªé¢„å¤„ç†çš„æ–‡ä»¶ï¼Œæ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š
```json
{
    "context": [
        {
            "content": "ä½ æœ‰ä»€ä¹ˆå® ç‰©å—ï¼Ÿ",
            "role": "user"
        }
    ],
    "chosen": {
        "content": "<think>\nå¥½çš„ï¼Œç”¨æˆ·é—®æˆ‘æœ‰æ²¡æœ‰å® ç‰©ã€‚æˆ‘éœ€è¦å…ˆç†è§£è¿™ä¸ªé—®é¢˜çš„æ„å›¾ã€‚ç”¨æˆ·å¯èƒ½åªæ˜¯å¥½å¥‡ï¼Œæˆ–è€…æƒ³æ‰¾ä¸ªè¯é¢˜èŠå¤©ï¼Œä¹Ÿå¯èƒ½è‡ªå·±æœ‰å® ç‰©æƒ³åˆ†äº«ç»éªŒã€‚é¦–å…ˆï¼Œæˆ‘è¦æ˜ç¡®ä½œä¸ºAIï¼Œæˆ‘æ²¡æœ‰çœŸå®çš„å® ç‰©ï¼Œä½†å¯ä»¥ç”Ÿæˆç›¸å…³çš„å†…å®¹ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘åº”è¯¥ç¤¼è²Œåœ°å›ç­”æˆ‘æ²¡æœ‰å® ç‰©ï¼Œä½†å¯ä»¥è®¨è®ºå® ç‰©ç›¸å…³çš„è¯é¢˜ã€‚ç”¨æˆ·å¯èƒ½æƒ³èŠèŠå…»å® ç‰©çš„ç»å†ã€å»ºè®®ï¼Œæˆ–è€…æœ‰è¶£çš„å® ç‰©æ•…äº‹ã€‚éœ€è¦ç¡®ä¿å›ç­”å‹å¥½ï¼Œå¹¶ä¸”æä¾›å¸®åŠ©çš„å¯èƒ½æ€§ã€‚\n\nç„¶åï¼Œè€ƒè™‘ç”¨æˆ·å¯èƒ½çš„æ·±å±‚éœ€æ±‚ã€‚æ¯”å¦‚ï¼Œä»–ä»¬å¯èƒ½åœ¨è€ƒè™‘å…»å® ç‰©ï¼Œéœ€è¦å»ºè®®ï¼›æˆ–è€…æƒ³æ‰¾äººåˆ†äº«ä»–ä»¬çš„å® ç‰©ç…§ç‰‡æˆ–æ•…äº‹ã€‚è¿™æ—¶å€™æˆ‘åº”è¯¥é‚€è¯·ä»–ä»¬æå‡ºå…·ä½“çš„é—®é¢˜æˆ–è¯é¢˜ï¼Œä»¥ä¾¿æ›´å¥½åœ°ååŠ©ã€‚\n\nè¿˜è¦æ³¨æ„è¯­æ°”è¦äº²åˆ‡ï¼Œé¿å…æœºæ¢°æ„Ÿã€‚ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢åŠ äº²å’ŒåŠ›ï¼Œä½†ä¸è¦è¿‡å¤šã€‚æœ€åæ£€æŸ¥å›ç­”æ˜¯å¦å‡†ç¡®ï¼Œç¡®ä¿æ²¡æœ‰é”™è¯¯ä¿¡æ¯ï¼ŒåŒæ—¶ä¿æŒè‡ªç„¶æµç•…ã€‚\n</think>\næˆ‘æ²¡æœ‰å® ç‰©å“¦ï¼Œä½†æˆ‘å¾ˆä¹æ„å’Œä½ èŠèŠå…³äºå® ç‰©çš„è¯é¢˜ï¼æ— è®ºæ˜¯å…»çŒ«ã€å…»ç‹—è¿˜æ˜¯å…¶ä»–å°åŠ¨ç‰©çš„ç»éªŒï¼Œè¿˜æ˜¯ä½ æƒ³åˆ†äº«çš„æœ‰è¶£æ•…äº‹ï¼Œæˆ‘éƒ½å¯ä»¥å¸®ä½ æä¾›ä¸€äº›å»ºè®®æˆ–ä¿¡æ¯~ ğŸ¾",
        "role": "assistant"
    },
    "rejected": {
        "content": "<think>\næ‚¨å¥½ï¼æˆ‘æ˜¯ç”±ä¸­å›½çš„æ·±åº¦æ±‚ç´¢ï¼ˆDeepSeekï¼‰å…¬å¸å¼€å‘çš„æ™ºèƒ½åŠ©æ‰‹DeepSeek-R1ã€‚æœ‰å…³æ¨¡å‹å’Œäº§å“çš„è¯¦ç»†å†…å®¹è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚\n</think>\næ‚¨å¥½ï¼æˆ‘æ˜¯ç”±ä¸­å›½çš„æ·±åº¦æ±‚ç´¢ï¼ˆDeepSeekï¼‰å…¬å¸å¼€å‘çš„æ™ºèƒ½åŠ©æ‰‹DeepSeek-R1ã€‚æœ‰å…³æ¨¡å‹å’Œäº§å“çš„è¯¦ç»†å†…å®¹è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚",
        "role": "assistant"
    },
    "reference_chosen_log_prob": -115.16470484400884,
    "reference_rejected_log_prob": -1.512190420944506,
    "meta": {
        "category_id": 1,
        "category_name": "A"
    }
}
```

æ•°æ®é…æ¯”é…ç½®æ–‡ä»¶æ ¼å¼å¦‚ä¸‹ï¼š
```json
{
    "data_name": "",
    "data_path": "",
    "ratio": [
        {
            "category_id": 1,
            "category_name": "",
            "size": 100,
            "sample_rate": 1.0
        },
        {
            "category_id": 2,
            "category_name": "",
            "size": 200,
            "sample_rate": 0.8
        }
    ]
}
```
ç”¨æˆ·éœ€ä¿®æ”¹æ•°æ®é¢„å¤„ç†é€»è¾‘ä»£ç  data/step1.preprocess.pyï¼Œå°†æ•°æ®å¤„ç†æˆç›®æ ‡æ ¼å¼ï¼Œå¹¶ç”Ÿæˆæ•°æ®é…æ¯”é…ç½®æ–‡ä»¶ã€‚
ç”¨æˆ·å¯æŒ‰éœ€ä¿®æ”¹é…æ¯”ã€‚


è¯¦è§æ•°æ®å¤„ç†è„šæœ¬
```bash
sh data_process.sh
```

### è®­ç»ƒ
```bash
sh train.sh
```
#### category-loss

```json
{
    "epoch": 2,
    "steps": 3,
    "lr": 1.22375e-05,
    "loss": 0.515095591545105,
    "coig/neo_loss": 0.5617072582244873,
    "stem_zh/phy_loss": 0.4811963737010956,
    "EduChat-Math_loss": 0.4951120913028717,
    "meta-math/GSM8K_zh_loss": 0.5640832781791687,
    "exam/coig_exam_loss": 0.6263442635536194,
    "gavinluo/applied_math_loss": 0.4919000566005707,
    "stem_zh/chem_loss": 0.4528641700744629,
    "stem_zh/bio_loss": 0.46091940999031067,
    "zhihu/zhihu_score9.0-10_clean_v10_loss": 0.5875096917152405,
    "xhs/xhs_loss": 0.7661288380622864,
    "stem_zh/med_loss": 0.42540857195854187,
    "human_value/100poison_loss": 0.5484293699264526,
    "ruozhiba/ruozhiba_ruozhiba_loss": 0.825197160243988,
    "logi_qa/logi-qa_loss": 0.6175104975700378,
    "Haijian/Advanced-Math_loss": 0.4288356602191925,
    "exam/kaoyan_loss": 0.6865882873535156
}
```
